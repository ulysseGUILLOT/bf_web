<!-- todo: score en diract apache kafka -->
<!-- todo: ajouter / supprimer joueur en cours de partie -->

{% extends "base.html" %}
{% block title %}Game{% endblock %}
{% block head %}
    {{ super() }}
    <script src="{{ url_for('static', filename='node_modules/jquery/dist/jquery.min.js') }}"></script>
{% endblock %}


{% block content %}
    <script>
        if("{{ game.finished }}" == "True") {
            location.href = '{{ url_for("end_game", game_id=game.id)}}'
        }
    </script>

    <div id="timer">60</div>
    <button id="playPauseBtn">▶</button>
    <h1 id="score">{{ game.white_score }} - {{ game.black_score }}</h1>

    <p>Début : {{ game.created_at.strftime('%Hh%M , %d-%m-%Y') }}</p>

    <h2>Joueurs blancs</h2>
    {% for assoc in game.users %}
        {% if assoc.team == 0 %}
            <p>{{ assoc.user.username }}</p>
            {% if game.finished == True %}
                <button class="score" disabled>But</button>
                <button class="score" disabled>Gamelle</button>
            {% else %}
                <button class="score" data-score="goal" data-user_id="{{ assoc.user.id }}">But</button>
                <button class="score" data-score="bounce_out" data-user_id="{{ assoc.user.id }}">Gamelle</button>
            {% endif %}
        {% endif %}
    {% endfor %}

    <h2>Joueurs noirs</h2>
    {% for assoc in game.users %}
        {% if assoc.team == 1 %}
            <p>{{ assoc.user.username }}</p>
            {% if game.finished == True %}
                <button class="score" disabled>But</button>
                <button class="score" disabled>Gamelle</button>
            {% else %}
                <button class="score" data-score="goal" data-user_id="{{ assoc.user.id }}">But</button>
                <button class="score" data-score="bounce_out" data-user_id="{{ assoc.user.id }}">Gamelle</button>
            {% endif %}
        {% endif %}
    {% endfor %}

    <p><a href="{{ url_for('index') }}">Retourner à l'accueil</a></p>

    <script>
        $('button.score').on("click", function () {
            $.ajax({
                type: "POST",
                url: "{{ url_for('goal', game_id=game.id) }}",
                data: { 
                    user_id: $(this).data('user_id'),
                    score_type: $(this).data('score'),
                    },
                success: function(response) {
                    if(response.message == 'end_game') {
                        location.href = '{{ url_for("end_game", game_id=game.id)}}'
                    }
                    $('#score').text(response.white_score + ' - ' + response.black_score)
                },
                error: function(xhr, status, error) {
                    console.error(error)
                }
            })
        })
    </script>
    <script src="{{ url_for('static', filename='clock.js') }}"></script>
{% endblock %}